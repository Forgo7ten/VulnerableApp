# WebView跨域漏洞

## 应用克隆漏洞

条件：`javaScriptEnabled=true && setAllowFileAccess=true && setAllowFileAccessFromFileURLs=true`

可获取应用内任意私有文件

### 漏洞复现

>   复现环境：Pixel_XL_API_27

参考AttackApp应用

## Cookie污染任意执行漏洞

## 应用克隆漏洞

条件：`javaScriptEnabled=true && setAllowFileAccess=true`

可获取应用内Cookie并加载执行Payload

### 漏洞复现

>   复现环境：Pixel_XL_API_27

参考AttackApp应用

## WebView File域同源策略绕过漏洞

WebView早期版本有效，**未能成功复现**

## 漏洞简介

Android 应用中存在包含webview 的可被导出 Activity 组件时，WebView setAllowFileAccess = true，setAllowFileAccessFromFileURLs= false，虽然不允许file url访问本地文件，但利用JavaScript 的延时执行能够绕过 file 协议的同源检查，并能够访问受害应用的所有私有文件，即通过 WebView 对 Javascript 的延时执行和将当前 Html文件删除掉并软连接指向其他文件就可以读取到被符号链接所指的文件，然后通过 JavaScript 再次读取 HTML 文件，即可获取到被符号链接所指的文件。

大多数使用WebView的应用都会受到该漏洞的影响，恶意应用通过该漏洞，可在无特殊权限下盗取应用的任意私有文件，尤其是浏览器，可通过利用该漏洞，获取到浏览器所保存的密码、Cookie、收藏夹以及历史记录等敏感信息，从而造成敏感信息泄露 。

### 漏洞详情

1.  WebView没有禁止使用file域：`setAllowFileAccess=true`；targetSDK≤Android10，该值**默认**为true；Android11及以上版本，该值默认为false。
2.  WebView打开了对JavaScript的支持：
3.  为了漏洞能够绕过同源策略，需要设置`setAllowFileAccessFromFileURLs=false`来禁止file域跨域访问。（不禁止就谈不上绕过了哈）

通过WebView对Javascript的延时执行；和将当前Html文件删除掉并软连接指向其他文件就可以读取到被符号链接所指的文件，然后通过JavaScript再次读取HTML文件，即可获取到被符号链接所指的文件。

因为读的是“同一个html文件”（URI相同），所以不会有跨域的限制。

### 修复建议

1.  将不必要导出的组件设置为不导出
    1.  如果应用的组件不必要导出，建议显式设置所注册组件的“android:exported”属性为false；
2.  如果需要导出组件，禁止使用File域
    1.  如果应用的需要导出包含WebView的组件，建议禁止使用File域协议：`WebView.getSettings.setAllowFileAccess(false);`
3.  如果需要使用File协议，禁止File协议调用JavaScript
    1.  如果应用的WebView需要使用File域协议，建议禁止File域协议调用JavaScript：`WebView.getSettings.setJavaScriptEnabled(false);`